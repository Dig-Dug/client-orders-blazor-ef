@page "/clients"
@inject AppDbContext Context
@inject NavigationManager Nav
@inject IJSRuntime JS
@using Microsoft.EntityFrameworkCore
@using ClientOrders.Core

<MudText Typo="Typo.h4" Class="mb-4">Clients</MudText>
<MudButton Variant="Variant.Filled"
             Color="Color.Primary"
             StartIcon="@Icons.Material.Filled.Add"
             OnClick="@(()=> Nav.NavigateTo("/clients/create"))"
>
Create Client
</MudButton>

<MudTable Items="clients" Class="mt-4" Hover="true" Dense="true">
    <HeaderContent>
        <MudTh>Name</MudTh>
        <MudTh>Orders</MudTh>
        <MudTh></MudTh>

    </HeaderContent>


<RowTemplate>
    <MudTh>@context.Name</MudTh>
    <MudTh>@context.Orders.Count</MudTh>
    <MudTh Align="Align.right">
        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                       Color="Color.Primary"
                       OnClick="@(()=> Nav.NavigateTo($"clients/edit/{context.Id}"))"
        />
            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                           Color="Color.Error"
                           OnClick="@(() => ConfirmDelete(context.Id))" />


    </MudTh>
</RowTemplate>

</MudTable>



@code{
    private List<Client> clients = new();

    protected override void OnInitialized()
    {
        clients = Context.Clients
            .Include(c => c.Orders)
            .ToList();
    }
    private async Task ConfirmDelete(int id){
        var confirmed = await JS.InvokeAsync<bool>(
            "confirm", "Delete this client?"
        );
        if (!confirmed)
            return;

        var client = await Context.Clients.FindAsync(id);
        if (client is null)
            return;

            Context.Clients.Remove(client);
            await Context.SaveChangesAsync();
            clients.Remove(client);
    }

}